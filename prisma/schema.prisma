generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                  String  @id
  userId              String  @map("user_id")
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
}

model acoes_gestor {
  id                String       @id
  mercadoId         String
  userId            String
  tipo              String
  descricao         String
  analiseId         String?
  resultadoEsperado Json?
  resultadoReal     Json?
  executadaEm       DateTime     @default(now())
  avaliadaEm        DateTime?
  analises_ia       analises_ia? @relation(fields: [analiseId], references: [id])
  mercados          mercados     @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id])

  @@index([mercadoId, executadaEm])
  @@index([userId, tipo])
}

model alertas_ia {
  id              String    @id
  mercadoId       String
  unidadeId       String?
  produtoId       String?
  tipo            String
  titulo          String
  descricao       String
  prioridade      String
  acaoRecomendada String?
  linkAcao        String?
  lido            Boolean   @default(false)
  lidoEm          DateTime?
  metadata        Json?
  criadoEm        DateTime  @default(now())
  expiradoEm      DateTime?
  mercados        mercados  @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  produtos        produtos? @relation(fields: [produtoId], references: [id])
  unidades        unidades? @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([criadoEm])
  @@index([mercadoId, lido, prioridade])
}

model analises_ia {
  id              String         @id
  mercadoId       String
  unidadeId       String?
  produtoId       String?
  tipo            String
  categoria       String?
  resultado       Json
  recomendacao    String
  prioridade      String
  impactoEstimado Decimal?       @db.Decimal(10, 2)
  status          String         @default("PENDENTE")
  feedbackGestor  String?
  aceitaEm        DateTime?
  executadaEm     DateTime?
  criadoEm        DateTime       @default(now())
  expiraEm        DateTime?
  acoes_gestor    acoes_gestor[]
  mercados        mercados       @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  produtos        produtos?      @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades        unidades?      @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([mercadoId, tipo, status])
  @@index([prioridade, status])
  @@index([unidadeId, criadoEm])
}

model estoques {
  id               String                  @id
  quantidade       Int                     @default(0)
  preco            Decimal                 @db.Decimal(10, 2)
  precoPromocional Decimal?                @db.Decimal(10, 2)
  emPromocao       Boolean                 @default(false)
  disponivel       Boolean                 @default(true)
  atualizadoEm     DateTime
  dataCriacao      DateTime                @default(now())
  unidadeId        String
  produtoId        String
  produtos         produtos                @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades         unidades                @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  movimentacoes    movimentacoes_estoque[]

  @@unique([unidadeId, produtoId])
}

model vendas {
  id             String   @id @default(uuid())
  produtoId      String
  unidadeId      String
  quantidade     Int
  precoUnitario  Decimal  @db.Decimal(10, 2)
  precoTotal     Decimal  @db.Decimal(10, 2)
  desconto       Decimal? @default(0) @db.Decimal(10, 2)
  formaPagamento String?
  clienteId      String?
  dataVenda      DateTime @default(now())
  criadoEm       DateTime @default(now())
  produtos       produtos @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades       unidades @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([produtoId, dataVenda])
  @@index([unidadeId, dataVenda])
  @@index([dataVenda])
  @@index([produtoId, unidadeId, dataVenda])
}

model movimentacoes_estoque {
  id                 String   @id @default(uuid())
  estoqueId          String
  produtoId          String
  unidadeId          String
  tipo               String
  quantidade         Int
  quantidadeAnterior Int
  quantidadeNova     Int
  motivo             String?
  observacao         String?
  responsavelId      String?
  dataMovimentacao   DateTime @default(now())
  criadoEm           DateTime @default(now())
  estoques           estoques @relation(fields: [estoqueId], references: [id], onDelete: Cascade)
  produtos           produtos @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades           unidades @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([produtoId, dataMovimentacao])
  @@index([unidadeId, dataMovimentacao])
  @@index([estoqueId, dataMovimentacao])
  @@index([tipo, dataMovimentacao])
  @@index([dataMovimentacao])
}

model logs_importacao {
  id               String           @id
  nomeArquivo      String
  tamanhoBytes     Int
  totalLinhas      Int              @default(0)
  linhasSucesso    Int              @default(0)
  linhasErro       Int              @default(0)
  linhasDuplicadas Int              @default(0)
  status           StatusImportacao @default(PROCESSANDO)
  mensagemErro     String?
  detalhesErros    String?
  dataInicio       DateTime         @default(now())
  dataFim          DateTime?
  mercadoId        String
  mercados         mercados         @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
}

model mercados {
  id                   String               @id
  nome                 String
  cnpj                 String               @unique
  descricao            String?
  telefone             String?
  emailContato         String?
  horarioFuncionamento String?
  logo                 String?
  ativo                Boolean              @default(true)
  dataCriacao          DateTime             @default(now())
  dataAtualizacao      DateTime
  planoId              String?
  gestorId             String?
  acoes_gestor         acoes_gestor[]
  alertas_ia           alertas_ia[]
  analises_ia          analises_ia[]
  logs_importacao      logs_importacao[]
  gestor               User?                @relation(fields: [gestorId], references: [id])
  planos_de_pagamento  planos_de_pagamento? @relation(fields: [planoId], references: [id])
  metricas_dashboard   metricas_dashboard[]
  unidades             unidades[]
}

model metricas_dashboard {
  id               String    @id
  mercadoId        String
  unidadeId        String?
  data             DateTime  @default(now())
  periodo          String
  giroEstoqueGeral Float     @default(0)
  taxaRuptura      Float     @default(0)
  valorEstoque     Decimal   @default(0) @db.Decimal(12, 2)
  diasCobertura    Float     @default(0)
  produtosAtivos   Int       @default(0)
  produtosInativos Int       @default(0)
  ticketMedio      Decimal   @default(0) @db.Decimal(10, 2)
  quantidadeVendas Int       @default(0)
  faturamentoDia   Decimal   @default(0) @db.Decimal(12, 2)
  margemLiquida    Float     @default(0)
  margemBruta      Float     @default(0)
  taxaConversao    Float     @default(0)
  taxaRecompra     Float     @default(0)
  clientesAtivos   Int       @default(0)
  clientesNovos    Int       @default(0)
  nps              Float?
  churnRate        Float?
  variacaoD1       Json?
  variacaoD7       Json?
  variacaoD30      Json?
  mercados         mercados  @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  unidades         unidades? @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@unique([mercadoId, data, periodo])
  @@index([mercadoId, data])
}

model planos_de_pagamento {
  id             String     @id
  nome           String
  descricao      String?
  valor          Decimal    @db.Decimal(10, 2)
  duracao        Int
  limiteUnidades Int        @default(1)
  limiteUploadMb Int        @default(10)
  limiteUsuarios Int        @default(5)
  ativo          Boolean    @default(true)
  dataCriacao    DateTime   @default(now())
  mercados       mercados[]
}

model produtos {
  id                                                                         String                  @id
  nome                                                                       String
  descricao                                                                  String?
  categoria                                                                  String?
  codigoBarras                                                               String?                 @unique
  marca                                                                      String?
  unidadeMedida                                                              String?
  imagem                                                                     String?
  ativo                                                                      Boolean                 @default(true)
  dataCriacao                                                                DateTime                @default(now())
  dataAtualizacao                                                            DateTime
  giroEstoqueMedio                                                           Float?                  @default(0)
  elasticidadePreco                                                          Float?                  @default(-1.2)
  demandaPrevista7d                                                          Int?                    @default(0)
  demandaPrevista30d                                                         Int?                    @default(0)
  pontoReposicao                                                             Int?                    @default(0)
  margemContribuicao                                                         Decimal?                @default(0) @db.Decimal(10, 2)
  scoreSazonalidade                                                          Float?                  @default(0.5)
  categoriaABC                                                               String?                 @default("C")
  ultimaAtualizacaoIA                                                        DateTime?
  alertas_ia                                                                 alertas_ia[]
  analises_ia                                                                analises_ia[]
  estoques                                                                   estoques[]
  movimentacoes_estoque                                                      movimentacoes_estoque[]
  produtos_relacionados_produtos_relacionados_produtoIdToprodutos            produtos_relacionados[] @relation("produtos_relacionados_produtoIdToprodutos")
  produtos_relacionados_produtos_relacionados_produtoRelacionadoIdToprodutos produtos_relacionados[] @relation("produtos_relacionados_produtoRelacionadoIdToprodutos")
  vendas                                                                     vendas[]
  itens_lista                                                                itens_lista[]
  savingsHistory                                                             SavingsHistory[]
}

model produtos_relacionados {
  id                                                            String   @id
  produtoId                                                     String
  produtoRelacionadoId                                          String
  tipo                                                          String
  confianca                                                     Float
  suporte                                                       Float
  lift                                                          Float
  geradoEm                                                      DateTime @default(now())
  produtos_produtos_relacionados_produtoIdToprodutos            produtos @relation("produtos_relacionados_produtoIdToprodutos", fields: [produtoId], references: [id], onDelete: Cascade)
  produtos_produtos_relacionados_produtoRelacionadoIdToprodutos produtos @relation("produtos_relacionados_produtoRelacionadoIdToprodutos", fields: [produtoRelacionadoId], references: [id], onDelete: Cascade)

  @@unique([produtoId, produtoRelacionadoId, tipo])
  @@index([produtoId, confianca])
}

model sessions {
  id           String   @id
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String    @id @default(uuid())
  tokenHash String    @unique @map("token_hash")
  userId    String    @map("user_id")
  expiresAt DateTime  @map("expires_at")
  revoked   Boolean   @default(false)
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revoked])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model unidades {
  id                    String                  @id
  nome                  String
  endereco              String?
  bairro                String?
  cidade                String?
  estado                String?
  cep                   String?
  telefone              String?
  horarioFuncionamento  String?
  latitude              Float?
  longitude             Float?
  ativa                 Boolean                 @default(true)
  dataCriacao           DateTime                @default(now())
  dataAtualizacao       DateTime
  mercadoId             String
  alertas_ia            alertas_ia[]
  analises_ia           analises_ia[]
  estoques              estoques[]
  metricas_dashboard    metricas_dashboard[]
  movimentacoes_estoque movimentacoes_estoque[]
  mercados              mercados                @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  vendas                vendas[]
}

model User {
  id                        String                     @id
  nome                      String?
  email                     String                     @unique
  emailVerified             DateTime?                  @map("email_verified")
  imagem                    String?
  senhaHash                 String?                    @map("senha_hash")
  role                      Role                       @default(CLIENTE)
  dataCriacao               DateTime                   @default(now()) @map("data_criacao")
  dataAtualizacao           DateTime                   @map("data_atualizacao")
  ultimoLogin               DateTime?                  @map("ultimo_login")
  accounts                  accounts[]
  acoes_gestor              acoes_gestor[]
  mercados                  mercados[]
  sessions                  sessions[]
  refreshTokens             RefreshToken[]
  userStreak                UserStreak?
  savingsHistory            SavingsHistory[]
  referralsAsReferrer       Referral[]                 @relation("referrer")
  referralsAsReferee        Referral[]                 @relation("referee")
  notificationSubscriptions NotificationSubscription[]

  @@map("usuarios")
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Role {
  CLIENTE
  GESTOR
  ADMIN
}

enum StatusImportacao {
  PROCESSANDO
  CONCLUIDO
  FALHA
  PARCIAL
}

// ============================================
// Gamificação e Listas (adicionados pelo Squad B)
// ============================================

model badges {
  id               String   @id
  name             String
  description      String
  icon             String
  category         String
  points           Int
  requirementType  String
  requirementValue Int
  createdAt        DateTime @default(now()) @map("created_at")

  user_badges user_badges[]

  @@map("badges")
}

model user_badges {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  badgeId    String   @map("badge_id")
  progress   Int      @default(0)
  unlockedAt DateTime @default(now()) @map("unlocked_at")

  badges badges @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model listas_compras {
  id        String   @id @default(uuid())
  nome      String
  usuarioId String   @map("usuario_id")
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  itens_lista    itens_lista[]
  savingsHistory SavingsHistory[]

  @@index([usuarioId])
  @@map("listas_compras")
}

model itens_lista {
  id         String  @id @default(uuid())
  listaId    String  @map("lista_id")
  produtoId  String  @map("produto_id")
  quantidade Int     @default(1)
  comprado   Boolean @default(false)

  listas_compras listas_compras @relation(fields: [listaId], references: [id], onDelete: Cascade)
  produtos       produtos       @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@map("itens_lista")
}

// ============================================
// Novos Models (Squad B - Dia 2)
// ============================================

model UserStreak {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  currentStreak Int      @default(0) @map("current_streak")
  longestStreak Int      @default(0) @map("longest_streak")
  lastLogin     DateTime @map("last_login")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_streaks")
}

model SavingsHistory {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  listId    String?  @map("list_id")
  productId String?  @map("product_id")
  pricePaid Int      @map("price_paid") // centavos
  avgPrice  Int      @map("avg_price") // centavos
  savings   Int // centavos
  date      DateTime @default(now())

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  list    listas_compras? @relation(fields: [listId], references: [id], onDelete: Cascade)
  product produtos?       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("savings_history")
}

model Referral {
  id          String    @id @default(uuid())
  code        String    @unique
  referrerId  String    @map("referrer_id")
  refereeId   String?   @map("referee_id")
  status      String    @default("pending") // pending, completed
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  referrer User  @relation("referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee  User? @relation("referee", fields: [refereeId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

model NotificationSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique // FCM token
  platform  String // web, android, ios
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId])
  @@map("notification_subscriptions")
}

// ============================================
// IA - Eventos do Usuário
// ============================================

model UserEvent {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  mercadoId String   @map("mercado_id")
  type      String // lista_criada, produto_adicionado_lista, etc
  timestamp DateTime @default(now())
  metadata  Json     @default("{}")

  @@index([userId, mercadoId])
  @@index([mercadoId, timestamp])
  @@index([type, timestamp])
  @@map("user_events")
}
