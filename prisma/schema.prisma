generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                  String  @id
  userId              String  @map("user_id")
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
}

model acoes_gestor {
  id                String       @id
  mercadoId         String
  userId            String
  tipo              String
  descricao         String
  analiseId         String?
  resultadoEsperado Json?
  resultadoReal     Json?
  executadaEm       DateTime     @default(now())
  avaliadaEm        DateTime?
  analises_ia       analises_ia? @relation(fields: [analiseId], references: [id])
  mercados          mercados     @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id])

  @@index([mercadoId, executadaEm])
  @@index([userId, tipo])
}

model alertas_ia {
  id              String    @id
  mercadoId       String
  unidadeId       String?
  produtoId       String?
  tipo            String
  titulo          String
  descricao       String
  prioridade      String
  acaoRecomendada String?
  linkAcao        String?
  lido            Boolean   @default(false)
  lidoEm          DateTime?
  metadata        Json?
  criadoEm        DateTime  @default(now())
  expiradoEm      DateTime?
  mercados        mercados  @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  produtos        produtos? @relation(fields: [produtoId], references: [id])
  unidades        unidades? @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([criadoEm])
  @@index([mercadoId, lido, prioridade])
}

model analises_ia {
  id              String         @id
  mercadoId       String
  unidadeId       String?
  produtoId       String?
  tipo            String
  categoria       String?
  resultado       Json
  recomendacao    String
  prioridade      String
  impactoEstimado Decimal?       @db.Decimal(10, 2)
  status          String         @default("PENDENTE")
  feedbackGestor  String?
  aceitaEm        DateTime?
  executadaEm     DateTime?
  criadoEm        DateTime       @default(now())
  expiraEm        DateTime?
  acoes_gestor    acoes_gestor[]
  mercados        mercados       @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  produtos        produtos?      @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades        unidades?      @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([mercadoId, tipo, status])
  @@index([prioridade, status])
  @@index([unidadeId, criadoEm])
}

model estoques {
  id               String                  @id
  quantidade       Int                     @default(0)
  preco            Decimal                 @db.Decimal(10, 2)
  precoPromocional Decimal?                @db.Decimal(10, 2)
  emPromocao       Boolean                 @default(false)
  disponivel       Boolean                 @default(true)
  atualizadoEm     DateTime
  dataCriacao      DateTime                @default(now())
  unidadeId        String
  produtoId        String
  produtos         produtos                @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades         unidades                @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  movimentacoes    movimentacoes_estoque[]

  @@unique([unidadeId, produtoId])
}

model vendas {
  id             String   @id @default(uuid())
  produtoId      String
  unidadeId      String
  quantidade     Int
  precoUnitario  Decimal  @db.Decimal(10, 2)
  precoTotal     Decimal  @db.Decimal(10, 2)
  desconto       Decimal? @default(0) @db.Decimal(10, 2)
  formaPagamento String? // DINHEIRO, CARTAO_CREDITO, CARTAO_DEBITO, PIX, etc
  clienteId      String? // Para rastrear compras de clientes recorrentes
  dataVenda      DateTime @default(now())
  criadoEm       DateTime @default(now())
  produtos       produtos @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades       unidades @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([produtoId, dataVenda])
  @@index([unidadeId, dataVenda])
  @@index([dataVenda])
  @@index([produtoId, unidadeId, dataVenda])
}

model movimentacoes_estoque {
  id                 String   @id @default(uuid())
  estoqueId          String
  produtoId          String
  unidadeId          String
  tipo               String // ENTRADA, SAIDA, AJUSTE, VENDA, DEVOLUCAO
  quantidade         Int
  quantidadeAnterior Int
  quantidadeNova     Int
  motivo             String? // COMPRA, VENDA, AJUSTE_INVENTARIO, PERDA, VENCIMENTO, etc
  observacao         String?
  responsavelId      String? // ID do usuário que fez a movimentação
  dataMovimentacao   DateTime @default(now())
  criadoEm           DateTime @default(now())
  estoques           estoques @relation(fields: [estoqueId], references: [id], onDelete: Cascade)
  produtos           produtos @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  unidades           unidades @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@index([produtoId, dataMovimentacao])
  @@index([unidadeId, dataMovimentacao])
  @@index([estoqueId, dataMovimentacao])
  @@index([tipo, dataMovimentacao])
  @@index([dataMovimentacao])
}

model logs_importacao {
  id               String           @id
  nomeArquivo      String
  tamanhoBytes     Int
  totalLinhas      Int              @default(0)
  linhasSucesso    Int              @default(0)
  linhasErro       Int              @default(0)
  linhasDuplicadas Int              @default(0)
  status           StatusImportacao @default(PROCESSANDO)
  mensagemErro     String?
  detalhesErros    String?
  dataInicio       DateTime         @default(now())
  dataFim          DateTime?
  mercadoId        String
  mercados         mercados         @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
}

model mercados {
  id                   String               @id
  nome                 String
  cnpj                 String               @unique
  descricao            String?
  telefone             String?
  emailContato         String?
  horarioFuncionamento String?
  logo                 String?
  ativo                Boolean              @default(true)
  dataCriacao          DateTime             @default(now())
  dataAtualizacao      DateTime
  planoId              String?
  gestorId             String?
  acoes_gestor         acoes_gestor[]
  alertas_ia           alertas_ia[]
  analises_ia          analises_ia[]
  logs_importacao      logs_importacao[]
  gestor               User?                @relation(fields: [gestorId], references: [id])
  planos_de_pagamento  planos_de_pagamento? @relation(fields: [planoId], references: [id])
  metricas_dashboard   metricas_dashboard[]
  unidades             unidades[]
}

model metricas_dashboard {
  id               String    @id
  mercadoId        String
  unidadeId        String?
  data             DateTime  @default(now())
  periodo          String
  giroEstoqueGeral Float     @default(0)
  taxaRuptura      Float     @default(0)
  valorEstoque     Decimal   @default(0) @db.Decimal(12, 2)
  diasCobertura    Float     @default(0)
  produtosAtivos   Int       @default(0)
  produtosInativos Int       @default(0)
  ticketMedio      Decimal   @default(0) @db.Decimal(10, 2)
  quantidadeVendas Int       @default(0)
  faturamentoDia   Decimal   @default(0) @db.Decimal(12, 2)
  margemLiquida    Float     @default(0)
  margemBruta      Float     @default(0)
  taxaConversao    Float     @default(0)
  taxaRecompra     Float     @default(0)
  clientesAtivos   Int       @default(0)
  clientesNovos    Int       @default(0)
  nps              Float?
  churnRate        Float?
  variacaoD1       Json?
  variacaoD7       Json?
  variacaoD30      Json?
  mercados         mercados  @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
  unidades         unidades? @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@unique([mercadoId, data, periodo])
  @@index([mercadoId, data])
}

model planos_de_pagamento {
  id             String     @id
  nome           String
  descricao      String?
  valor          Decimal    @db.Decimal(10, 2)
  duracao        Int
  limiteUnidades Int        @default(1)
  limiteUploadMb Int        @default(10)
  limiteUsuarios Int        @default(5)
  ativo          Boolean    @default(true)
  dataCriacao    DateTime   @default(now())
  mercados       mercados[]
}

model produtos {
  id                                                                         String                  @id
  nome                                                                       String
  descricao                                                                  String?
  categoria                                                                  String?
  codigoBarras                                                               String?                 @unique
  marca                                                                      String?
  unidadeMedida                                                              String?
  imagem                                                                     String?
  ativo                                                                      Boolean                 @default(true)
  dataCriacao                                                                DateTime                @default(now())
  dataAtualizacao                                                            DateTime
  giroEstoqueMedio                                                           Float?                  @default(0)
  elasticidadePreco                                                          Float?                  @default(-1.2)
  demandaPrevista7d                                                          Int?                    @default(0)
  demandaPrevista30d                                                         Int?                    @default(0)
  pontoReposicao                                                             Int?                    @default(0)
  margemContribuicao                                                         Decimal?                @default(0) @db.Decimal(10, 2)
  scoreSazonalidade                                                          Float?                  @default(0.5)
  categoriaABC                                                               String?                 @default("C")
  ultimaAtualizacaoIA                                                        DateTime?
  alertas_ia                                                                 alertas_ia[]
  analises_ia                                                                analises_ia[]
  estoques                                                                   estoques[]
  vendas                                                                     vendas[]
  movimentacoes_estoque                                                      movimentacoes_estoque[]
  produtos_relacionados_produtos_relacionados_produtoIdToprodutos            produtos_relacionados[] @relation("produtos_relacionados_produtoIdToprodutos")
  produtos_relacionados_produtos_relacionados_produtoRelacionadoIdToprodutos produtos_relacionados[] @relation("produtos_relacionados_produtoRelacionadoIdToprodutos")
}

model produtos_relacionados {
  id                                                            String   @id
  produtoId                                                     String
  produtoRelacionadoId                                          String
  tipo                                                          String
  confianca                                                     Float
  suporte                                                       Float
  lift                                                          Float
  geradoEm                                                      DateTime @default(now())
  produtos_produtos_relacionados_produtoIdToprodutos            produtos @relation("produtos_relacionados_produtoIdToprodutos", fields: [produtoId], references: [id], onDelete: Cascade)
  produtos_produtos_relacionados_produtoRelacionadoIdToprodutos produtos @relation("produtos_relacionados_produtoRelacionadoIdToprodutos", fields: [produtoRelacionadoId], references: [id], onDelete: Cascade)

  @@unique([produtoId, produtoRelacionadoId, tipo])
  @@index([produtoId, confianca])
}

model sessions {
  id           String   @id
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model unidades {
  id                    String                  @id
  nome                  String
  endereco              String?
  bairro                String?
  cidade                String?
  estado                String?
  cep                   String?
  telefone              String?
  horarioFuncionamento  String?
  latitude              Float?
  longitude             Float?
  ativa                 Boolean                 @default(true)
  dataCriacao           DateTime                @default(now())
  dataAtualizacao       DateTime
  mercadoId             String
  alertas_ia            alertas_ia[]
  analises_ia           analises_ia[]
  estoques              estoques[]
  vendas                vendas[]
  movimentacoes_estoque movimentacoes_estoque[]
  metricas_dashboard    metricas_dashboard[]
  mercados              mercados                @relation(fields: [mercadoId], references: [id], onDelete: Cascade)
}

model User {
  id              String         @id
  nome            String?
  email           String         @unique
  emailVerified   DateTime?      @map("email_verified")
  imagem          String?
  senhaHash       String?        @map("senha_hash")
  role            Role           @default(CLIENTE)
  dataCriacao     DateTime       @default(now()) @map("data_criacao")
  dataAtualizacao DateTime       @map("data_atualizacao")
  ultimoLogin     DateTime?      @map("ultimo_login")
  accounts        accounts[]
  sessions        sessions[]
  acoes_gestor    acoes_gestor[]
  mercados        mercados[]

  @@map("usuarios")
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Role {
  CLIENTE
  GESTOR
  ADMIN
}

enum StatusImportacao {
  PROCESSANDO
  CONCLUIDO
  FALHA
  PARCIAL
}
